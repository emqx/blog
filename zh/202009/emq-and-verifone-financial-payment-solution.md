![画板 18.png](https://static.emqx.net/images/243743a615af54ea2aa3a876fc778bf6.png)

**2019 年 8 月，美国 Verifone（惠尔丰）和 EMQ 签订合作协议，由 EMQ 为 Verifone 的新一代金融电子支付系统提供基础设施软件——EMQX Enterprise，用以连接 Verifone 在全球千万级别的支付终端设备**。到现在为止，EMQX Enterprise 已经在 Verifone 的生产环境稳定运行超过一年。现在，让我们来回顾一下这个项目。



## 背景

 Verifone（惠尔丰）是一家全球领先的安全电子交易解决方案提供商，在硬件支付方面一直处于行业第一的地位。数十年来，Verifone 在全球超过 150 个国家提供了产品和服务，每年完成的交易数量超过 100 亿笔，占全球所有支付交付量的 46%。<!--（数据来源：Verifone官网）--> 

Verifone 的海量交易数、遍布全球的客户以及它悠久的行业耕耘历史使其占据了市场领先地位，但同时也为其带来了海量繁杂的历史存留设备、业务通讯以及消息交换。长期以来，Verifone 一直在寻找一个适合的业务系统升级方案，以应对数字支付时代的新挑战。经过对现有系统的审视，公司发现大部分设备会在长期内保持每5分钟一次的数据推送频率，考虑到百万乃至千万级别的设备存量以及未来可能的持续增量，公司每天将面临庞大的数据推送量。同时，公司现有系统所使用的 HTTPS 协议先天存在一定的延时，它将随着系统的扩容而同步增大。只有尽快升级系统，才能避免延时进一步扩大。因此， **Verifone 亟需一个能够处理海量消息交换的全新实时系统** 。而根据以往的经验，实现这样的系统升级需要高昂的成本，且难度很大。

 

## 选型

对于新系统，在通讯协议方面，考虑到延时的缺陷，Verifone 决定在新设备接入协议选择上摒弃 HTTPS，仅将其用于支持存量设备；并考察了 AMQP 和 MQTT 另外两种协议， **发现专为物联网应用设计的 MQTT 协议所具备的超轻量、低资源需求（带宽、耗电等）等特性更适合海量手持设备的接入** 。

在确定采用 MQTT 协议之后，Verifone 的技术团队开始了选型工作，对市面上所有的开源及商业 MQTT Broker 进行了逐一考量。同时，团队也得到了汽车行业一些同仁对于 EMQ 的推荐。技术团队全面评估了 EMQ 及其他同类产品并进行了相应的 PoC，考量的方面包括功能、性能、稳定性、可扩展性等，甚至在终端上进行的通讯时电池消耗也在考量范围内。

根据 Verifone 技术团队的评测，EMQX Enterprise 由成熟领先的技术团队主导开发，其采用的高并发、高稳定的开发语言 Erlang/OTP使其具备了突出的性能， **在相同的硬件设施条件下，EMQX Enterprise 能够提供的服务能力是同业软件的倍数级别，可以为 Verifone 节约大量的基础设施费用** 。 同时，EMQX Enterprise 的稳定性和可扩展性也非常优异，支持最多的第三方数据处理服务，并将在未来版本中提供规则引擎以简化业务开发，为 Verifone 节约时间和开发成本。<!--（注：截至本文发布时，EMQX Enterprise 最新版本已支持规则引擎功能。）-->

在选型过程中，除了技术指标，Verifone 也考察了 EMQ 产品的服务支持能力和财务稳定性，结果均令人满意。

 

## 方案

![finance_pay.png](https://static.emqx.net/images/653e69ebebf147e3e3e648c8f9c554fa.png)

Verifone 的部署方案是一个包括既有系统和设备的演进式方案，整个方案的 rollout 将跨越多个财务年度。

Verifone 的支付系统以多集群的方式分布在美洲、欧洲、亚洲等大区，升级在某一大区逐渐展开，并随后复制其经验至其他大区。

### 接入侧

新设备使用 MQTT over TLS 通讯协议，既有设备使用既有协议（HTTPS）。通过协议转换网关，既有设备可以协议转换网关和 EMQ 通讯。

### 服务侧

EMQX Enterprise 前端部署了 LB 做负载均衡并终结 TLS 连接，后端部署了某型数据库为数据持久化服务和存放离线消息。同时，该数据库也用于存储 Authentication 和 ACL 数据，提供设备接入安全和应用层访问控制安全。Verifone 在服务侧还部署了 Kafka 数据流服务，EMQX Enterprise 的高性能 Kafka 数据桥接能高速地将消息转发至 Kafka，供其他后台业务使用。

### 服务层面

EMQX Enterprise 提供了丰富的 API 接口，可以以少量开发投入支持不断加入的业务服务，满足业务增长需求。

### 数据层面

新设备使用 JSON 数据格式。当前版本的 EMQX Enterprise 支持解析 JSON Payload，并能以消息内容和消息事件触发规则引擎，在后续应用中，这一点无疑会为应用开发提供不少方便。

 

## 结语

无论是 EMQ 的团队还是 EMQX Enterprise 产品，在 Verifone 的选型、PoC 和到目前的部署进展中都显示出了卓越的能力。 **随着合作的进一步加深，EMQ 也将不断完善在金融与支付领域的解决方案，为 Verifone 提供更好的产品和服务，并在未来帮助领域内更多企业从容应对数字化、信息化挑战** 。
